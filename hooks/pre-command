# Set build meta-data based on plugin inputs
buildkite-agent meta-data set "CONDITIONAL_PIPELINE_SLUG" "$BUILDKITE_PLUGIN_CONDITIONAL_PIPELINE_BUILDER_CONDITIONAL_PIPELINE_SLUG"
echo "CONDITIONAL_PIPELINE_SLUG=$(buildkite-agent meta-data get CONDITIONAL_PIPELINE_SLUG)"

# Create a set that will store all the paths we want to check against, check to see if any of the changed files belong to these paths if so set LINT_GROUP to true
# BuildKite has no docs on this :( trial and error based on https://forum.buildkite.community/t/plugin-inputs-as-array/1747

changed_files=$(git diff --name-only origin/main...HEAD)
echo $changed_files

group_lint_paths=()
i=0

echo "wtf=$(BUILDKITE_PLUGIN_CONDITIONAL_PIPELINE_BUILDER_LINT_GROUP_0)"

while [ -n "$(eval echo \$BUILDKITE_PLUGIN_CONDITIONAL_PIPELINE_BUILDER_LINT_GROUP_${i})" ]
do
    path="$(eval echo \$BUILDKITE_PLUGIN_CONDITIONAL_PIPELINE_BUILDER_CONDITIONAL_PIPELINE_BUILDER_LINT_GROUP_${i})"
    echo "$path"
    group_lint_paths+=("$path")
    i=$((i + 1))
done

echo $group_lint_paths

for path in "${group_lint_paths[@]}"; do
  if echo "$changed_files" | grep -q "^$path"; then
    echo "At least one changed file belongs to $path"
    echo "Setting RUN_LINT to true"
    buildkite-agent meta-data set "RUN_LINT" "true"
    break
  fi
done

# buildkite-agent meta-data set "LINT_GROUP" "$BUILDKITE_PLUGIN_CONDITIONAL_PIPELINE_BUILDER_CONDITIONAL_PIPELINE_BUILDER_LINT_GROUP"
# echo "BUILDKITE_PLUGIN_CONDITIONAL_PIPELINE_BUILDER_LINT_GROUP=$BUILDKITE_PLUGIN_CONDITIONAL_PIPELINE_BUILDER_LINT_GROUP"

